@using SmartTouch.CRM.ApplicationServices.ViewModels
@using System.Threading
@using System.Linq
@using SmartTouch.CRM.Web.Utilities
@model IEnumerable<ThirdPartyClientViewModel>


@{
    ViewBag.Title = "ApiKeysList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var userID = ViewBag.userid == null ? null : ViewBag.userid;
}



@using (Ajax.BeginForm("ApiKeysList", null, new AjaxOptions { UpdateTargetId = "content-area", OnSuccess = "OnSuccess", OnFailure = "OnFailure" }, new { @id = "file_upload" }))
{
    <div id="ApiKeyslist">
        <div class="page-title">[|Api Keys|]</div>
        <div class="ApiKeys-grid">
            @(Html.Kendo().Grid<SmartTouch.CRM.ApplicationServices.ViewModels.ThirdPartyClientViewModel>()
    .Name("apikeygrid")
    .HtmlAttributes(new { @class = "k-grid-content" })
    .AutoBind(true)
    .Columns(columns =>
    {
        columns.Template(e => "").Title("").HeaderHtmlAttributes(new { @style = "width:60px;" });
        columns.Template(e => "").Title("[|Api Key|]").HeaderHtmlAttributes(new { @class = "col-30" });
        columns.Template(e => "").Title("[|Status|]").HeaderHtmlAttributes(new { @class = "col-15" });
        columns.Template(e => "").Title("[|App Name|]").HeaderHtmlAttributes(new { });
        columns.Template(e => "").Title("[|Account Name|]").HeaderHtmlAttributes(new { });
        columns.Template(e => "").Title("").HeaderHtmlAttributes(new { @style = "width:80px;" });
    })
     .ToolBar(toolbar =>
    {
        toolbar.Template(@<text>
                <div class="toolbar grid-ct-header">

                    <div class="right-part">
                        <div class="grid-search">
                            <input type="search" id="txtapikeysearch" onkeydown="GetApiKeyBasedonsearch(event);" class=" form-control" placeholder="[|Search|]" />
                            <i class="icon st-icon-search-2"></i>
                        </div>
                        <div class="grid-controls">
                            <span class="sort-label">[|Filter by|]</span>
                            <span class="sort-select" id="userTypes">
                                @(Html.Kendo().DropDownList()
                                    .Name("filterType")
                                            .DataTextField("Text")
                                            .DataValueField("Value")
                                     .Events(e => e.Change("filtertypeChange"))
                                    .BindTo(new List<SelectListItem>() {
                                        new SelectListItem() {
                                            Text = "[|All|]",
                                            Value = "0"
                                        },
                                        new SelectListItem() {
                                            Text = "[|Active|]",
                                            Value = "1"
                                        },
                                        new SelectListItem() {
                                            Text = "[|Inactive|]",
                                            Value = "2"
                                        }
                                })
                                )
                            </span>
                        </div>
                    </div>
                </div>
        </text>);
    })

     .ClientRowTemplate(
                          @"<tr class='odd'>
                            <td></td>
                            <td>#:ID#</td>
                            <td>#if (IsActive==1) {# <span class='at-active bold'>Active</span> #}else {# <span class='at-inactive bold'>Inactive</span> #}#</td>
                            <td>#:Name#</td>
                            <td>#:AccountName#</td>
                            <td class='grid-row-controls'>
                                <span>
                                    <a href='/editapikey?apiKeyID=#:ID#' title='Edit Api Key'><i class='icon st-icon-edit'></i></a>
                                    <a href='javascript:void(0)' class='apikeyid' onclick='DeleteApiKey(this)'  data-id='#:ID #' title='Delete Api Key' ><i class='icon st-icon-bin-3'></i></a>
                                </span>
                            </td>
                        </tr>")

                                    .Events(events => events.DataBinding("onDataBinding").DataBound("onDataBound"))
                                    .DataSource(dataSource => dataSource
                                    .Ajax()
                                    .Read(read => read.Action("GetAllApiKeysList", "APIKeys").Data("searchParameters"))
                                    )
            )
        </div>
    </div>
}

@section Scripts{
    <script>
        var userId = '@userID';

        function searchParameters() {
            var parameters = {
                name: localStorage.getItem("apikeysearchtext"),
                filterdata: localStorage.getItem("filtercontent"),
                userid: userId
            }
            return parameters;
        }
    </script>

    <script>

        var searchText;

        localStorage.removeItem("filtercontent");
        localStorage.removeItem("apikeysearchtext");

        function onDataBinding(arg) {
            //setTimeout(function () {
            //    appendCheckbox();
            //    bindCheckboxchnage('chkleadscore');
            //    $(".st-icon-edit").parent('a').attr('data-target', '#modal');
            //}, 200)
        }

        function onDataBound(e) {

            var colCount = $(".k-grid").find('table colgroup > col').length;
            //var dataSource = new kendo.data.DataSource({
            //    data: ToPageDropdown()
            //});
            //$("select[data-role='dropdownlist']").data('kendoDropDownList').setDataSource(dataSource);
            if (e.sender.dataSource.view().length == 0) {
                e.sender.table.find('tbody').append('<tr><td colspan="' + colCount + '"><div class="notecordsfound"><div><i class="icon st-icon-browser-windows-2"></i></div><span class="bolder smaller-90">[|No records found|]</span></div></td></tr>')
            }
        }

        function GetApiKeyBasedonsearch(e) {
            setTimeout(function () {
                var enterKeyPressCode = 13;
                if (searchText !== $("#txtapikeysearch").val() || (searchText === $("#txtapikeysearch").val() && e.keyCode == enterKeyPressCode))
                    searchText = $("#txtapikeysearch").val();
                else
                    return;

                $filter = new Array();
                var grid = $("#apikeygrid").data("kendoGrid"), searchBox = $("#txtapikeysearch").val();
                localStorage.removeItem("apikeysearchtext");
                if ($.trim(searchBox).length > 2) {
                    localStorage.setItem("apikeysearchtext", searchBox);
                    // var psize = readCookie("actionpagesize");
                    var grid = $("#actiongrid").data("kendoGrid")
                    $("#apikeygrid").data("kendoGrid").dataSource.read();
                    // grid.dataSource.query({ page: 1, pageSize: psize });
                    // appendCheckbox();
                }
                else if ($.trim(searchBox).length === 0) {
                    localStorage.removeItem("apikeysearchtext");
                    $("#apikeygrid").data("kendoGrid").dataSource.read();
                    appendCheckbox();
                }
            }, 500);
        }

        $('#txtapikeysearch').keypress(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
                window.location = "/apikeys";
            }
        });

        function filtertypeChange() {
            var value = this.value();
            localStorage.setItem("filtercontent", value);
            $("#apikeygrid").data("kendoGrid").dataSource.read();
        };

        function DeleteApiKey(e) {

            var apikey = $(e).attr("data-id");
            alertifyReset("Delete Api Key", "Cancel");
            alertify.confirm("[|Are you sure you want to delete this Api Key|]?", function (e) {
                if (e) {
                    var lsid = apikey;
                    jsondata = JSON.stringify({
                        'ID': lsid,

                    });
                    var DeleteURL = "deleterapikey";
                    jQuery.support.cors = true;
                    $.ajax({
                        url: DeleteURL,
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify({ 'apiKey': jsondata })
                    }).then(function (response) {
                        var filter = $.Deferred()
                        if (response.success) {
                            filter.resolve(response)
                        } else {
                            filter.reject(response.error)
                        }
                        return filter.promise()
                    }).done(function (data) {
                        pageLoader();
                        notifySuccess("[|Successfully deleted the ApiKey|]");
                        // $("#gridApiKey").data("kendoGrid").dataSource.read();

                        setTimeout(
                                    function () {
                                        window.location.href = "/apikeys";
                                    }, setTimeOutTimer);

                    }).fail(function (error) {
                        notifyError(error);
                    })
                }
                else {
                    notifyError("[|You've clicked Cancel|]");
                }
            });
        }

        $(document).ready(function () {
            var dropDown = $("#filterType").data("kendoDropDownList");
            if (userId == null || userId != 0)
                dropDown.select(1);
            else {
                dropDown.select(0);
                dropDown.trigger("change");
            }
            var grid = $('#apikeygrid').data('kendoGrid');


        });
    </script>
}

